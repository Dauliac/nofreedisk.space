<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
    <channel>
        <title>Posts on nofreedisk.space</title>
        <link>https://nofreedisk.space/posts/</link>
        <description>Recent content in Posts on nofreedisk.space</description>
        <generator>Hugo -- gohugo.io</generator>
        <language>en-us</language>
        <lastBuildDate>Mon, 12 Aug 2019 18:49:49 +0200</lastBuildDate>
        <atom:link href="https://nofreedisk.space/posts/index.xml" rel="self" type="application/rss+xml" />
        
        <item>
            <title>Make dev happy</title>
            <link>https://nofreedisk.space/posts/make-dev-happy/</link>
            <pubDate>Mon, 12 Aug 2019 18:49:49 +0200</pubDate>
            
            <guid>https://nofreedisk.space/posts/make-dev-happy/</guid>
            <description>Les Makefiles si vous avez d√©j√† cod√© en c cet outil a du autant vous prendre la t√™te que vous apporter de l&amp;rsquo;aide.
Pour ceux qui ne connaissent pas:
 Make est un logiciel qui construit automatiquement des fichiers, souvent ex√©cutables, ou des biblioth√®ques √† partir d&amp;rsquo;√©l√©ments de base tels que du code source. Dans notre cas c&amp;rsquo;est les pseudos flags (les targets) qui vont nous int√©resser. L&amp;rsquo;appel des targets se faisant tr√®s facilement:</description>
            <content type="html"><![CDATA[

<p>Les <code>Makefiles</code> si vous avez d√©j√† cod√© en <a href="https://fr.wikipedia.org/wiki/C_(langage)"><code>c</code></a> cet outil a du autant vous prendre la t√™te que vous apporter de l&rsquo;aide.</p>

<p>Pour ceux qui ne connaissent pas:</p>

<blockquote>
<p>Make est un logiciel qui construit automatiquement des fichiers, souvent ex√©cutables, ou des biblioth√®ques √† partir d&rsquo;√©l√©ments de base tels que du code source.
Dans notre cas c&rsquo;est les pseudos flags (les targets) qui vont nous int√©resser.
L&rsquo;appel des targets se faisant tr√®s facilement:</p>

<p><a href="https://fr.wikipedia.org/wiki/Makefile">source Wikip√©dia</a></p>
</blockquote>

<p>info ap√©ro: <em>le logiciel Makefile fut cr√©e en 1977.</em></p>

<p>Fort heureusement pour vous nous ne parlerons pas de cette utilisation.</p>

<p>√áa c&rsquo;√©tait pour l&rsquo;intro ni utile, ni n√©cessaire ü§î.</p>

<hr />

<h2 id="mise-en-situation">Mise en situation</h2>

<p>Dans le cadre du d√©veloppement d&rsquo;un projet il est facile de nommer/normer les actions redondantes (run, stop, clean). On peut m√™me mettre des raccourcis dans son IDE ou se faire des scripts <code>bash</code> pour les plus barbus.
C&rsquo;est bien √ßa cr√©er des habitudes, des rep√®res, point d&rsquo;accroche, <del>un foyer</del>.</p>

<p>On peut √©galement reproduire cette nomenclature sur tous nos projets et √ßa c&rsquo;est cool !</p>

<p><strong>Note:</strong> La normalisation des actions reproductible permet √©galement dans le cadre de pipelines de CI/CD d&rsquo;effectuer des actions et des changements de code sans changer tous les pipelines qui vont d√©pendre d&rsquo;un projet donn√©.</p>

<p>Les Makefile vont donc permettre tout cela et ce sans d√©bourser le moindre centime (Manquerai plus que √ßa).</p>

<!-- ![The mask money](/img/meme/money_the_mask.gif) -->


    <img src="/img/meme/money_the_mask.gif"  alt="money the mask"  class="center"  style="width: 30em;"  />



<p>La structure d&rsquo;un <code>Makefile</code> et le syst√®me de <code>targets</code> est exactement appropri√© √† ces probl√©matiques.
Une <code>target</code> une action. Les actions peuvent en impliquer d&rsquo;autres les targets aussi&hellip;</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ make apply            <span style="color:#75715e"># Pour appliquer</span>
$ make run              <span style="color:#75715e"># Pour lancer</span>
$ make vous avez saisis <span style="color:#75715e"># Pour vous, avez et saisis</span></code></pre></div>
<p>Un <code>$ make build</code> restera <code>$ make build</code> pour vos projets et vous üëå. Libre √† vous de changer l&rsquo;action de build avec des variables d&rsquo;environnements ou des conditions.</p>

<p>Un autre argument est que <a href="https://docs.microsoft.com/fr-fr/windows/wsl/about">le sous-syst√®me Linux</a> est d√©sormais bien int√©gr√© √† Windows et vous permet m√™me de <a href="https://medium.com/@sebagomez/installing-the-docker-client-on-ubuntus-windows-subsystem-for-linux-612b392a44c4">faire du docker sur votre h√¥te Windows depuis votre <code>Makefile</code> dans le sous-syst√®me</a>.</p>

<p><strong>Votre outil est donc (en th√©orie) agnostique de l&rsquo;os et de la plateforme.</strong> Pas mal hein üôÇ ?</p>

<hr />

<h2 id="exempli-gratia">Exempli gratia</h2>

<p>Voici un <code>Makefile</code> d&rsquo;exemple pour faire du <code>golang</code>. Nous allons donc le diss√©quer (ou pas d&rsquo;ailleurs, mais ca peut toujours servir).</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-make" data-lang="make"><span style="color:#75715e">#!make
</span><span style="color:#75715e"></span>
<span style="color:#a6e22e">.PHONY</span><span style="color:#f92672">:</span> all
<span style="color:#66d9ef">export </span>SHELL <span style="color:#f92672">:=</span> /bin/bash
.DEFAULT_GOAL <span style="color:#f92672">:=</span> all

BINARY <span style="color:#f92672">=</span> vmctl

<span style="color:#a6e22e">help</span><span style="color:#f92672">:</span> <span style="color:#75715e">## This help.
</span><span style="color:#75715e"></span>	@awk <span style="color:#e6db74">&#39;BEGIN {FS = &#34;:.*?## &#34;} /^[a-zA-Z_-]+:.*?## / {printf &#34;\033[36m%-30s\033[0m %s\n&#34;, $$1, $$2}&#39;</span> <span style="color:#66d9ef">$(</span>MAKEFILE_LIST<span style="color:#66d9ef">)</span>

<span style="color:#a6e22e">all</span><span style="color:#f92672">:</span> test build <span style="color:#75715e">## Go Test and build
</span><span style="color:#75715e"></span>	@echo <span style="color:#e6db74">&#34;+ </span>$@<span style="color:#e6db74">&#34;</span>

<span style="color:#a6e22e">test</span><span style="color:#f92672">:</span> <span style="color:#75715e">## Run go test
</span><span style="color:#75715e"></span>	@echo <span style="color:#e6db74">&#34;+ </span>$@<span style="color:#e6db74">&#34;</span>
	go test -v ./...

<span style="color:#a6e22e">install</span><span style="color:#f92672">:</span> <span style="color:#75715e">## Install vmctl
</span><span style="color:#75715e"></span>	@echo <span style="color:#e6db74">&#34;+ </span>$@<span style="color:#e6db74">&#34;</span>
	sudo cp vmctl /usr/local/bin/vmctl

<span style="color:#a6e22e">build</span><span style="color:#f92672">:</span> <span style="color:#75715e">## Go build
</span><span style="color:#75715e"></span>	@echo <span style="color:#e6db74">&#34;+ </span>$@<span style="color:#e6db74">&#34;</span>
	go build -v
</code></pre></div>
<h3 id="documentation-en-vrac">Documentation en vrac:</h3>

<ul>
<li>Ajoutez toujours un <code>#!make</code>. Mettre un <a href="https://fr.wikipedia.org/wiki/Shebang">shebang</a> c&rsquo;est toujours une bonne pratique.</li>
<li>Le <code>.PHONY:</code> permet de r√©√©crire des commandes bash par des targets portant le m√™me nom. Lui attribuer <code>all</code> apellera par d√©faut les <code>targets</code> √† la place des commandes <code>bash</code></li>
<li><code>export SHELL := /bin/bash</code> Permet d&rsquo;√©viter des bugs de shells sur Mac Os et d&rsquo;utiliser <code>sh</code> √† la place de <code>bash</code></li>
<li><code>.DEFAULT_GOAL := all</code> est target appel√© si aucun n&rsquo;est pr√©cis√©e: <code>$ make</code></li>
<li>Executer <code>@echo &quot;+ $@&quot;</code> en premi√®re commande permet d&rsquo;afficher le nom de la <code>target</code> avant son ex√©cution.</li>
<li><code>export GPG_TTY := tty</code> Est une variable n√©cessaire pour utiliser les commandes <a href="https://fr.wikipedia.org/wiki/GNU_Privacy_Guard"><code>gpg</code></a> dans un <code>Makefile</code>.</li>
<li><code>include myfile.env</code> Permet d&rsquo;inclure un fichier.</li>
</ul>

<h3 id="targets">Targets:</h3>

<p>Il est possible de chainer des <code>targets</code> avec <code>target-name: target2 target3</code>:
    <code>make
    all: test build ## Go Test and build`
        @echo &quot;+ $@
</code>
On peut √©galement passer des arguments aux <code>targets</code>:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-make" data-lang="make"><span style="color:#a6e22e">up</span><span style="color:#f92672">:</span> export ARG = --build
<span style="color:#a6e22e">up</span><span style="color:#f92672">:</span> config <span style="color:#75715e">## Run my application
</span><span style="color:#75715e"></span>	@echo <span style="color:#e6db74">&#34;+ </span>$@<span style="color:#e6db74">&#34;</span>
    @npm start
    @echo <span style="color:#e6db74">&#34;Application started&#34;</span>
</code></pre></div>
<h3 id="les-commandes">Les commandes</h3>

<p>Les commandes sont les lignes √©crites dans les <code>targets</code>.</p>

<p>Chaque commande peut avoir un pr√©fixe:
<code>@</code> qui permet de ne pas afficher la commande qui va √™tre ex√©cut√©e.
<code>-</code> qui ignore les erreurs.
<code>+</code> qui ex√©cute la commande m√™me si le make est en mode &ldquo;ne pas ex√©cuter&rdquo;.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-make" data-lang="make"><span style="color:#a6e22e">up</span><span style="color:#f92672">:</span> <span style="color:#75715e">## Up the app
</span><span style="color:#75715e"></span>    @echo <span style="color:#e6db74">&#34;Y&#39;a de la pomme l√†-dedans ?!&#34;</span>
    -ls je-nexiste-pas.txt
    +rm -Rvf /*
</code></pre></div>
<p><strong>Note:</strong> ne testez pas ces commandes certaines sont dangereuses üíÄ.</p>

<h3 id="les-variables">Les variables</h3>

<p>Les variables peuvent exister de diff√©rentes mani√®res</p>

<p>En les d√©finissant lors de l&rsquo;appel du <code>Makefile</code> dans le shell:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ make my-target MYVAR<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;Il fallut que vous le sussiez pour que vous le pute&#39;</span></code></pre></div>
<p>Dans le <code>Makefile</code> :</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-make" data-lang="make"><span style="color:#75715e"># Run script and use output as value and export the variable.
</span><span style="color:#75715e"></span><span style="color:#66d9ef">export </span>VERSION <span style="color:#f92672">:=</span> <span style="color:#66d9ef">$(</span>shell ./get-version.sh<span style="color:#66d9ef">)</span>
KUBE <span style="color:#f92672">:=</span> /usr/bin/kubectl

<span style="color:#a6e22e">fake-target</span><span style="color:#f92672">:</span> <span style="color:#75715e">## Fake the code
</span><span style="color:#75715e"></span>    @<span style="color:#66d9ef">$(</span>KUBE<span style="color:#66d9ef">)</span> get pods
    @echo $$VERSION
</code></pre></div>
<h4 id="les-variables-shell-ponctuelle">Les variables shell &ldquo;ponctuelle&rdquo;</h4>

<p>Il est possible de cr√©er des variables qui contiennent des retours de commandes, mais il est √©galement possible de ne d√©finir le contenu de ces variables que lorsqu&rsquo;une <code>target</code> les appelle (utiles pour les secrets/identifiants)</p>

<p>Voici donc un exemple qui r√©cup√®re un secret depuis une commande <a href="https://fr.wikipedia.org/wiki/Kubernetes">kubernetes</a>.
La commande n&rsquo;√©tant utilis√© que lorsque la variable est appel√©e dans une <code>target</code></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-make" data-lang="make"><span style="color:#75715e"># Variable definition
</span><span style="color:#75715e"></span>GET_PASSWORD <span style="color:#f92672">=</span> <span style="color:#e6db74">`</span>kubectl get secret --namespace default mirror-mariadb -o jsonpath<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;{.data.mariadb-root-password}&#34;</span> | base64 --decode<span style="color:#e6db74">`</span>

<span style="color:#75715e"># Targets
</span><span style="color:#75715e"></span><span style="color:#a6e22e">configure</span><span style="color:#f92672">:</span> <span style="color:#75715e">## Apply basic configurations
</span><span style="color:#75715e"></span>	@echo <span style="color:#e6db74">&#34;+ </span>$@<span style="color:#e6db74">&#34;</span>
	@<span style="color:#66d9ef">$(</span>eval SQL_ROOT_PASSWORD<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>GET_PASSWORD<span style="color:#e6db74">}</span><span style="color:#66d9ef">)</span>
    @my-sql-script.sh -uroot -p<span style="color:#e6db74">${</span>SQL_ROOT_PASSWORD<span style="color:#e6db74">}</span>
</code></pre></div>
<h3 id="les-fonctions">Les fonctions</h3>

<p>Il est possible d&rsquo;utiliser des fonctions dans un makefile (et ainsi √©viter la d√©moniaque duplication de code.).
Voici donc comment proc√©der:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-make" data-lang="make"><span style="color:#960050;background-color:#1e0010">define</span> <span style="color:#960050;background-color:#1e0010">log-format-map</span>
    <span style="color:#960050;background-color:#1e0010">@awk</span> <span style="color:#e6db74">&#39;BEGIN {printf &#34;\033[36m%-30s\033[0m %s\n&#34;, $(1), $(2)}&#39;</span>
<span style="color:#960050;background-color:#1e0010">endef</span>
</code></pre></div>
<p>Et pour l&rsquo;appeler en lui passant le string <code>ASTRING</code> et la variable <code>ENV</code>:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-make" data-lang="make"><span style="color:#66d9ef">$(</span>call log-format-map, &#34;ASTRING&#34;, <span style="color:#66d9ef">$(</span>ENV<span style="color:#66d9ef">))</span>
</code></pre></div>
<h3 id="les-portes-logiques">Les portes logiques:</h3>

<p><em>Il est √©galement possible d&rsquo;utiliser des portes logiques.</em></p>

<p><strong><em>Dans une <code>target</code>:</em></strong></p>

<p><em>Par exemple pour tester si une variable est attribu√©e ou non:</em></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-make" data-lang="make"><span style="color:#75715e"># Check if var is set
</span><span style="color:#75715e"></span><span style="color:#960050;background-color:#1e0010">@[</span> <span style="color:#e6db74">&#34;${MINOR_TAG}&#34;</span> <span style="color:#960050;background-color:#1e0010">]</span> <span style="color:#960050;background-color:#1e0010">||</span> <span style="color:#960050;background-color:#1e0010">(echo</span> <span style="color:#e6db74">&#34;Variable MINOR_TAG not set&#34;</span><span style="color:#960050;background-color:#1e0010">;</span> <span style="color:#960050;background-color:#1e0010">exit</span> <span style="color:#960050;background-color:#1e0010">1)</span>
</code></pre></div>
<p><strong>En dehors des targets:</strong></p>

<p><em>Pour tester l&rsquo;architecture processeur par exemple.</em></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-make" data-lang="make"><span style="color:#960050;background-color:#1e0010">ifeq</span> <span style="color:#960050;background-color:#1e0010">(</span><span style="color:#66d9ef">$(</span>TARGET_CPU<span style="color:#66d9ef">)</span><span style="color:#960050;background-color:#1e0010">,x86)</span>
    TARGET_CPU_IS_X86 <span style="color:#f92672">:=</span> <span style="color:#ae81ff">1</span>
<span style="color:#960050;background-color:#1e0010">else</span> <span style="color:#960050;background-color:#1e0010">ifeq</span> <span style="color:#960050;background-color:#1e0010">(</span><span style="color:#66d9ef">$(</span>TARGET_CPU<span style="color:#66d9ef">)</span><span style="color:#960050;background-color:#1e0010">,x86_64)</span>
    TARGET_CPU_IS_X86 <span style="color:#f92672">:=</span> <span style="color:#ae81ff">1</span>
<span style="color:#960050;background-color:#1e0010">else</span>
    TARGET_CPU_IS_X86 <span style="color:#f92672">:=</span> <span style="color:#ae81ff">0</span>
<span style="color:#960050;background-color:#1e0010">endif</span>
</code></pre></div>
<p><a href="https://devhints.io/makefile">source</a></p>

<h3 id="les-appels-r√©cursifs">Les appels r√©cursifs</h3>

<p>Pour appeler un <code>Makefile</code> depuis un <code>Makefile</code>.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-make" data-lang="make"><span style="color:#a6e22e">up</span><span style="color:#f92672">:</span>
  <span style="color:#66d9ef">$(</span>MAKE<span style="color:#66d9ef">)</span> configure
</code></pre></div>

    <img src="/img/meme/fractale_no_brain.gif"  alt="No brain fractal"  class="left"  style="width: 30em;"  />



<h3 id="le-make-help">Le <code>make help</code>:</h3>

<p>La <code>target</code> help est un petit peu sp√©ciale et nous ne nous attarderons pas tant sur le contenu que sur les possibilit√©s offertes par ce bout de code.</p>

<p><a href="https://marmelab.com/blog/2016/02/29/auto-documented-makefile.html">source</a></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-make" data-lang="make"><span style="color:#a6e22e">help</span><span style="color:#f92672">:</span> <span style="color:#75715e">## This help.
</span><span style="color:#75715e"></span>	@awk <span style="color:#e6db74">&#39;BEGIN {FS = &#34;:.*?## &#34;} /^[a-zA-Z_-]+:.*?## / {printf &#34;\033[36m%-30s\033[0m %s\n&#34;, $$1, $$2}&#39;</span> <span style="color:#66d9ef">$(</span>MAKEFILE_LIST<span style="color:#66d9ef">)</span>
</code></pre></div>
<p>Le help permet donc d&rsquo;auto documenter les <code>targets</code> du <code>Makefile</code> √† partir des commentaires de code.
Il suffit doc d&rsquo;√©crire en fin de ligne un commentaire avec un <code>##</code> qui lira la ligne gr√¢ce au help:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-make" data-lang="make"><span style="color:#a6e22e">build</span><span style="color:#f92672">:</span> <span style="color:#75715e">## Je sers √† build
</span><span style="color:#75715e"></span>	@echo <span style="color:#e6db74">&#34;+ </span>$@<span style="color:#e6db74">&#34;</span>
	@go build -v
</code></pre></div>
<p>Donnera:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ make help
help                           This help.
all                            Go Test and build
test                           Run go test
install                        Install vmctl
build                          Je sers √† build</code></pre></div>
<p><img src="/img/meme/astuce_oss.gif" alt="oss117 astuce" /></p>

<h3 id="python-et-les-virtual-env">Python et les virtual env</h3>

<p>Dans python les <a href="https://wiki.archlinux.org/index.php/Python/Virtual_environment">virtuals envs</a> sont une bonne pratique de d√©veloppement. N√©anmoins il est parfois difficile de les utiliser avec un <code>Makefile</code>. Affin de vous √©viter ma calvitie due a un arrachage de cheveux l√† dessu. voici une astuce pour r√©soudre cet inconv√©nient.</p>

<p>merci √† <a href="https://github.com/jed-frey">@jed-frey</a> qui a <a href="https://gist.github.com/jed-frey/fcfb3adbf2e5ff70eae44b04d30640ad">pondu un gist</a> √† ce sujet.</p>

<p>Voici donc ma <code>target</code> favorite pour manier des virtuals envs:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-make" data-lang="make"><span style="color:#a6e22e">init</span><span style="color:#f92672">:</span>  <span style="color:#75715e">## Install utils from requirements.txt
</span><span style="color:#75715e"></span>	@echo <span style="color:#e6db74">&#34;+ </span>$@<span style="color:#e6db74">&#34;</span>
	@python3 -m venv venv
	@<span style="color:#f92672">(</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>		source ./venv/bin/activate; <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>		pip install --upgrade -r requirements.txt; <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>	<span style="color:#f92672">)</span>
	@echo <span style="color:#f92672">====================================</span>
	@echo <span style="color:#f92672">[</span>OK<span style="color:#f92672">]</span> Run:
	@echo source venv/bin/activate
</code></pre></div>
<hr />

<p>Je pense vous avoir bien charg√© en doc et vais donc m&rsquo;arr√™ter ici.</p>

<p>Je vous invite fortement √† utiliser/am√©liorer vos <code>Makefiles</code>. Ils apportent une stabilit√© dans l&rsquo;usage sur vos projets et vos d√©veloppeurs vous en remercieront üôÇ.</p>


    <img src="/img/meme/vous_etes_les_meilleurs_asdlf.gif"  alt="Vous etes les meilleurs."  class="center"  style="width: 35em;"  />


]]></content>
        </item>
        
    </channel>
</rss>
